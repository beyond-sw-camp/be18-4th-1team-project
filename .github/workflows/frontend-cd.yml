name: Frontend CD

on:
  pull_request:
    branches:
      - develop

jobs:
  deploy:
    runs-on: self-hosted
    name: "Deploy to Local Kubernetes"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check kubectl context
        shell: pwsh
        run: |
          kubectl config current-context
          kubectl get nodes

      - name: Apply Kubernetes manifests
        shell: pwsh
        working-directory: ./frontend/smerp-client/k8s
        run: |
          kubectl apply -f service.yaml
          kubectl apply -f deployment.yaml

      - name: Update Deployment with new image
        shell: powershell
        run: |
          $IMAGE_TAG = "${{ github.sha }}"
          Write-Host "Deploying image tag: $IMAGE_TAG"
          $DOCKER_USER = "${{ secrets.FRONT_DOCKER_USERNAME }}"
          $IMAGE_NAME = "${{ secrets.FRONT_IMAGE_NAME }}"
          $FULL_IMAGE = "$DOCKER_USER/$IMAGE_NAME:${IMAGE_TAG}"
          Write-Host "Setting image to: $FULL_IMAGE"
          kubectl set image deployment/smerp-frontend `
            smerp-frontend=$FULL_IMAGE

      - name: Wait for rollout to complete
        shell: pwsh
        run: |
          kubectl rollout status deployment/smerp-frontend --timeout=90s

      - name: Check running pods and services
        shell: pwsh
        run: |
          kubectl get pods -o wide
          kubectl get svc -o wide
